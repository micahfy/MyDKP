<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MirAcLe DKP 省流版</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        margin: 16px;
        background: #0f172a;
        color: #e2e8f0;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 12px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 6px 8px;
        text-align: left;
        font-size: 14px;
      }
      th {
        background: #1e293b;
      }
      #status {
        margin-top: 8px;
        font-size: 13px;
      }
      button,
      select {
        padding: 4px 8px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <h1>MirAcLe DKP 省流模式</h1>
    <div>
      <label for="teamSelect">选择团队：</label>
      <select id="teamSelect"></select>
      <label for="classSelect" style="margin-left:8px;">职业：</label>
      <select id="classSelect">
        <option value="all">全部</option>
      </select>
      <button id="refreshBtn">刷新</button>
    </div>
    <div id="status"></div>
    <div id="detailPanel" style="margin-top:16px; display:none;">
      <h2 id="detailTitle" style="margin-bottom:8px;">玩家明细</h2>
      <div id="detailStatus" style="font-size:13px; margin-bottom:6px;">
        点击下方表格中的玩家以查看记录
      </div>
      <table>
        <thead>
          <tr>
            <th>时间</th>
            <th>类型</th>
            <th>变动</th>
            <th>原因</th>
            <th>操作人</th>
          </tr>
        </thead>
        <tbody id="detailBody">
          <tr>
            <td colspan="5">尚未选择玩家</td>
          </tr>
        </tbody>
      </table>
    </div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>角色名</th>
          <th>职业</th>
          <th>当前DKP</th>
          <th>总获得</th>
          <th>总消耗</th>
          <th>出席率</th>
        </tr>
      </thead>
      <tbody id="playerBody">
        <tr>
          <td colspan="7">正在加载...</td>
        </tr>
      </tbody>
    </table>

    <script>
      const teamSelect = document.getElementById('teamSelect');
      const playerBody = document.getElementById('playerBody');
      const classSelect = document.getElementById('classSelect');
      const statusBox = document.getElementById('status');
      const refreshBtn = document.getElementById('refreshBtn');
      const detailPanel = document.getElementById('detailPanel');
      const detailBody = document.getElementById('detailBody');
      const detailStatus = document.getElementById('detailStatus');
      const detailTitle = document.getElementById('detailTitle');
      const CLASS_COLORS = {
        战士: '#C79C6E',
        圣骑士: '#F58CBA',
        猎人: '#ABD473',
        盗贼: '#FFF569',
        牧师: '#FFFFFF',
        萨满祭司: '#0070DE',
        法师: '#69CCF0',
        术士: '#9482C9',
        德鲁伊: '#FF7D0A',
      };
      let currentPlayers = [];

      async function loadTeams() {
        status('正在加载团队列表...');
        try {
          const res = await fetch('/api/teams/basic');
          const teams = await res.json();
          teamSelect.innerHTML = '';
          teams.forEach((team) => {
            const option = document.createElement('option');
            option.value = team.id;
            option.textContent = team.name;
            teamSelect.appendChild(option);
          });
          if (teams.length > 0) {
            await loadPlayers();
          } else {
            status('暂无团队数据');
            playerBody.innerHTML =
              '<tr><td colspan="7">暂无团队</td></tr>';
          }
        } catch (err) {
          status('团队列表加载失败');
          playerBody.innerHTML =
            '<tr><td colspan="7">无法加载团队数据</td></tr>';
        }
      }

      async function loadPlayers() {
        const teamId = teamSelect.value;
        if (!teamId) {
          playerBody.innerHTML =
            '<tr><td colspan="7">请先选择团队</td></tr>';
          return;
        }
        status('正在加载玩家数据...');
        playerBody.innerHTML =
          '<tr><td colspan="7">正在加载...</td></tr>';
        try {
          const res = await fetch(`/api/players?teamId=${teamId}`);
          const players = await res.json();
          if (!Array.isArray(players) || players.length === 0) {
            playerBody.innerHTML =
              '<tr><td colspan="7">该团队暂无玩家</td></tr>';
            status('已加载，暂无玩家');
            return;
          }

          playerBody.innerHTML = '';
          players.forEach((player, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${index + 1}</td>
              <td>${player.name}</td>
              <td>${player.class}</td>
              <td>${Number(player.currentDkp || 0).toFixed(1)}</td>
              <td>${Number(player.totalEarned || 0).toFixed(1)}</td>
              <td>${Number(player.totalSpent || 0).toFixed(1)}</td>
              <td>${Math.round((player.attendance || 0) * 100)}%</td>
            `;
            playerBody.appendChild(row);
          });
          currentPlayers = players;
          populateClassOptions(players);
          renderTable();
          const now = new Date();
          status(`已加载，共 ${players.length} 人。更新时间 ${now.toLocaleString()}`);
        } catch (err) {
          status('玩家数据加载失败');
          playerBody.innerHTML =
            '<tr><td colspan="7">无法加载玩家数据</td></tr>';
        }
      }

      function populateClassOptions(players) {
        const existing = new Set(['all']);
        Array.from(classSelect.options).forEach((opt) =>
          existing.add(opt.value)
        );
        players.forEach((player) => {
          if (!existing.has(player.class)) {
            const option = document.createElement('option');
            option.value = player.class;
            option.textContent = player.class;
            classSelect.appendChild(option);
            existing.add(player.class);
          }
        });
      }

      function renderTable() {
        const filterClass = classSelect.value;
        const filtered = currentPlayers.filter((player) => {
          if (filterClass === 'all') return true;
          return player.class === filterClass;
        });
        if (filtered.length === 0) {
          playerBody.innerHTML =
            '<tr><td colspan="7">筛选条件下暂无玩家</td></tr>';
          return;
        }
        playerBody.innerHTML = '';
        filtered.forEach((player, index) => {
          const color = CLASS_COLORS[player.class] || '#888888';
          const row = document.createElement('tr');
          row.style.cursor = 'pointer';
          row.addEventListener('click', () => loadPlayerLogs(player));
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>
              <span style="
                color:${color};
                font-weight:600;
              ">
                ${player.name}
              </span>
            </td>
            <td>
              <span style="
                display:inline-block;
                padding:2px 6px;
                border:1px solid ${color};
                color:${color};
              ">
                ${player.class}
              </span>
            </td>
            <td>${Number(player.currentDkp || 0).toFixed(1)}</td>
            <td>${Number(player.totalEarned || 0).toFixed(1)}</td>
            <td>${Number(player.totalSpent || 0).toFixed(1)}</td>
            <td>${Math.round((player.attendance || 0) * 100)}%</td>
          `;
          playerBody.appendChild(row);
        });
      }

      function status(message) {
        statusBox.textContent = message;
      }
      function detailStatusMessage(message) {
        detailStatus.textContent = message;
      }

      async function loadPlayerLogs(player) {
        detailPanel.style.display = 'block';
        detailPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        detailTitle.textContent = `${player.name} - ${player.class}`;
        detailStatusMessage('正在加载记录...');
        detailBody.innerHTML =
          '<tr><td colspan="5">加载中...</td></tr>';
        try {
          const res = await fetch(`/api/dkp/logs?playerId=${player.id}&limit=50`);
          const data = await res.json();
          if (!res.ok || !Array.isArray(data)) {
            detailBody.innerHTML =
              '<tr><td colspan="5">无法获取该玩家记录</td></tr>';
            detailStatusMessage(data?.error || '获取记录失败');
            return;
          }
          if (data.length === 0) {
            detailBody.innerHTML =
              '<tr><td colspan="5">暂无记录</td></tr>';
            detailStatusMessage('该玩家暂无日志记录');
            return;
          }
          detailBody.innerHTML = '';
          data.forEach((log) => {
            const tr = document.createElement('tr');
            const changeValue =
              (log.change > 0 ? '+' : '') +
              Number(log.change || 0).toFixed(1);
            tr.innerHTML = `
              <td>${new Date(log.createdAt).toLocaleString()}</td>
              <td>${log.type || ''}</td>
              <td>${changeValue}</td>
              <td>${log.reason || ''}</td>
              <td>${log.operator || ''}</td>
            `;
            detailBody.appendChild(tr);
          });
          detailStatusMessage(`共 ${data.length} 条记录（最多显示 50 条）`);
        } catch (error) {
          detailBody.innerHTML =
            '<tr><td colspan="5">无法获取该玩家记录</td></tr>';
          detailStatusMessage('获取记录失败');
        }
      }

      refreshBtn.addEventListener('click', loadPlayers);
      classSelect.addEventListener('change', renderTable);
      loadTeams();
    </script>
  </body>
</html>
